<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>जग्गा न्युनतम मूल्याङ्कन</title>
<style>
body { font-family: 'Mangal', Arial, sans-serif; padding: 20px; line-height:1.6; font-size:14px; }
label { margin: 0 5px; font-weight: bold; }
input, button, select { padding: 6px; margin: 2px 0; }
.inline { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout:auto; }
th, td { border: 1px solid #555; padding: 4px; font-size: 13px; white-space: normal; word-wrap: break-word; }
th { background: #eee; text-align:center; }
#templateOutput { margin-top: 20px; font-size: 16px; padding: 10px; background: #f7f7f7; text-align: justify; }
button { cursor: pointer; }

/* PRINT */
@media print { 
    body * { visibility: hidden !important; } 
    #printContainer, #printContainer * { visibility: visible !important; } 
    #printContainer { position: absolute; top:0; left:1in; width:calc(100% - 1in); } /* left margin 1" */
    #templateOutput { font-size:14px !important; text-align: justify; line-height:1.55em; } 
    #resultTable th, #resultTable td { font-size:12px !important; } 
    .no-print { display:none !important; } 
}

.upper-table td, .upper-table th { border:1px solid #888; padding:4px; text-align:center; }
.upper-table th { background:#ddd; }

/* Column compacting */
td.price, th.price { width:80px; text-align:right; }
td.area, th.area { width:120px; }
td.road { width:160px; }
td.category { width:100px; }

</style>
</head>
<body>

<h2>जग्गा न्युनतम मूल्याङ्कन फारम</h2>

<!-- Upper Part -->
<div class="inline">
<label>आर्थिक वर्ष:</label><input type="text" id="t5" value="०८२/८३" readonly>
</div>

<div class="inline">
<label>स्थानीय तह:</label><input type="text" id="t1">
<label>वडा नं.:</label><input type="text" id="t2">
<label>च.नं.:</label><input type="text" id="t3">
<label>मिति:</label><input type="text" id="t4" placeholder="YYYY.MM.DD">
<button type="button" onclick="addUpperEntry()">+</button>
<button type="button" onclick="saveHistory()">सेभ</button>
</div>

<div id="upperListContainer" style="margin-top:10px;"></div>

<hr>

<!-- Lower Part -->
<div class="inline">
<label>जिल्ला:</label><input type="text" id="district" value="सिन्धुपाल्चोक">
<label>साविक गा.वि.स.:</label><input type="text" id="old_vdc" oninput="autoFillPrice()">
<label>वडा नं.:</label><input type="text" id="ward">
<label>कित्ता नं.:</label><input type="text" id="kitta">
</div>

<div class="inline">
<label>क्षेत्रफल इनपुट प्रकार:</label>
<select id="areaType" onchange="toggleAreaInput()">
<option value="traditional">रोपनी / आना / पैसा / दाम</option>
<option value="sqm">वर्गमिटर (m²)</option>
</select>
</div>

<div id="traditionalArea" class="inline">
<label>R-A-P-D:</label>
<input type="number" id="ropani" placeholder="रोपनी" min="0">
<input type="number" id="aana" placeholder="आना" min="0" max="15">
<input type="number" id="paisa" placeholder="पैसा" min="0" max="3">
<input type="number" id="dam" placeholder="दाम" min="0" max="3">
</div>

<div id="sqmArea" class="inline" style="display:none;">
<label>वर्गमिटर (m²):</label><input type="number" id="sqm" min="0">
</div>

<div class="inline">
<label>घरबाटो सिफारिस भएको बाटोको विवरण:</label>
<input list="roadOptions" id="road">
<datalist id="roadOptions"><option value="नभएको"><option value="गोरेटो बाटो"></datalist>

<label>वर्गिकरण गरिएको क्षेत्र:</label>
<input list="categoryOptions" id="category">
<datalist id="categoryOptions"><option value="आवासीय"><option value="कृषि"><option value="व्यवसायिक"></datalist>

<label>मुल्य प्रति रोपनी:</label><input type="number" id="pricePerRopani">
</div>

<div class="inline" style="margin-top:5px;">
<button type="button" onclick="addSameGaVISA()">Add (Same GaVISA)</button>
<button type="button" onclick="addNewGaVISA()">Add (New GaVISA)</button>
</div>

<!-- Output -->
<div id="printContainer">
<div id="templateOutput"></div>
<table id="resultTable" style="display:none;">
<thead>
<tr>
<th>क्र.<br>सं.</th>
<th>जिल्ला</th>
<th>साविक<br>गा.वि.स.</th>
<th>वडा<br>नं.</th>
<th>कित्ता<br>नं.</th>
<th class="area">क्षेत्रफल</th>
<th class="road">घरबाटो विवरण</th>
<th class="category">वर्गिकरण</th>
<th class="price" colspan="1">मूल्य प्रति<br> रोपनी (रू)</th>
<th class="price">न्युनतम मूल्य</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td colspan="9" style="text-align:right;font-weight:bold;" id="sumText">जम्मा :</td>
<td id="sumValue"></td>
</tr>
</tfoot>
</table>
</div>

<script>
// ----------------- UTILITY -----------------
let upperEntries = [];
let LOWER_ENTRIES = [];

function toNepali(num){
    return num.toString().replace(/\d/g,d=>'०१२३४५६७८९'[d]);
}

function toggleAreaInput(){
    const t=document.getElementById("areaType").value;
    document.getElementById("traditionalArea").style.display=t==='traditional'?'flex':'none';
    document.getElementById("sqmArea").style.display=t==='sqm'?'flex':'none';
}

function ropaniToRAPD(r){
    let R=Math.floor(r), rem=(r-R)*16;
    let A=Math.floor(rem); rem=(rem-A)*4;
    let P=Math.floor(rem); rem=(rem-P)*4;
    let D=+(rem.toFixed(2));
    return {R,A,P,D};
}

function getArea(){
    const type=document.getElementById("areaType").value;
    if(type==='traditional'){
        let r=parseFloat(document.getElementById("ropani").value)||0;
        let a=parseFloat(document.getElementById("aana").value)||0;
        let p=parseFloat(document.getElementById("paisa").value)||0;
        let d=parseFloat(document.getElementById("dam").value)||0;
        let ropani=r+a/16+p/64+d/256;
        let sqm=ropani*508.74;
        let rapdText=`${toNepali(r)}-${toNepali(a)}-${toNepali(p)}-${toNepali(d)}\n(${toNepali(sqm.toFixed(2))} व.मि)`; 
        return { rapdText, ropani };
    } else {
        let sqm=parseFloat(document.getElementById("sqm").value)||0;
        let ropani=sqm/508.74;
        let rapd=ropaniToRAPD(ropani);
        let rapdText=`${toNepali(rapd.R)}-${toNepali(rapd.A)}-${toNepali(rapd.P)}-${toNepali(rapd.D)}\n(${toNepali(sqm.toFixed(2))} व.मि)`;
        return { rapdText, ropani };
    }
}

// ----------------- NUMBER TO NEPALI WORDS -----------------
const NUMBERS_NE = ["शुन्य","एक","दुई","तीन","चार","पाँच","छ","सात","आठ","नौ","दस","एघार","बाह्र","तेह्र","चौध","पन्ध्र","सोह्र","सत्र","अठार","उन्नाइस","बीस","एक्काइस","बाइस","तेइस","चौबीस","पच्चीस","छब्बीस","सत्ताइस","अठ्ठाइस","उनन्तीस","तीस","एकतीस","बत्तीस","तेत्तीस","चौँतीस","पैंतीस","छत्तीस","सैंतीस","अठतीस","उनन्चालीस","चालीस","एकचालीस","बयालीस","त्रिचालीस","चवालीस","पैँतालीस","छयालीस","सत्चालीस","अठचालीस","उनन्चास","पचास","एकाउन्न","बाउन्न","त्रिपन्न","चवन्न","पचपन्न","छपन्न","सन्ताउन्न","अन्ठाउन्न","उनन्साठी","साठी","एकसट्ठी","बैसट्ठी","त्रिसट्ठी","चौसट्ठी","पैंसट्ठी","छैंसट्ठी","सडसट्ठी","अठसट्ठी","उनन्सत्तरी","सत्तरी","एकहत्तर","बहत्तर","त्रिहत्तर","चौरहत्तर","पचहत्तर","छयहत्तर","सतहत्तर","अठहत्तर","उनासी","अस्सी","एकासी","बयासी","त्रियासी","चौरासी","पचासी","छयासी","सतासी","अठासी","उनान्नब्बे","नब्बे","एकान्नब्बे","बयान्नब्बे","त्रियान्नब्बे","चौरान्नब्बे","पन्चान्नब्बे","छयान्नब्बे","सन्तानब्बे","अन्ठान्नब्बे","उनान्सय","सय"];

function convertToNepaliWords(num){
    if(num===0) return "शुन्य";
    let words="";
    const crore=Math.floor(num/10000000); num%=10000000;
    const lakh=Math.floor(num/100000); num%=100000;
    const thousand=Math.floor(num/1000); num%=1000;
    const hundred=Math.floor(num/100); num%=100;
    if(crore>0) words+=NUMBERS_NE[crore]+" करोड ";
    if(lakh>0) words+=NUMBERS_NE[lakh]+" लाख ";
    if(thousand>0) words+=NUMBERS_NE[thousand]+" हजार ";
    if(hundred>0) words+=NUMBERS_NE[hundred]+" सय ";
    
    if(num>0){
        if(num<=100) words+=NUMBERS_NE[Math.floor(num)]+" ";
        else{
            let tens=Math.floor(num/10)*10;
            let units=num%10;
            if(tens>0) words+=NUMBERS_NE[tens]+" ";
            if(units>0) words+=NUMBERS_NE[units]+" ";
        }
    }
    return words.trim();
}

function numberToNepaliWords(num){
    let intPart=Math.floor(num);
    let dec=Math.round((num-intPart)*100);
    let words=convertToNepaliWords(intPart)+" रूपैँया";
    if(dec>0) words+=" "+convertToNepaliWords(dec)+" पैसा";
    words+=" मात्र";
    return words;
}


// ----------------- UPPER ENTRY -----------------
function addUpperEntry(){
    const t1=document.getElementById("t1").value.trim();
    const t2=document.getElementById("t2").value.trim();
    const t3=document.getElementById("t3").value.trim();
    const t4=document.getElementById("t4").value.trim();
    if(!t1||!t2||!t3||!t4){ alert("कृपया सबै माथि भर्नुहोस्।"); return; }
    upperEntries.push({t1,t2,t3,t4});
    renderUpperList();
    document.getElementById("t1").value=""; document.getElementById("t2").value=""; document.getElementById("t3").value=""; document.getElementById("t4").value="";
}

function renderUpperList(){
    const container=document.getElementById("upperListContainer");
    if(upperEntries.length===0){ container.innerHTML=""; return;}
    let html='<table class="upper-table"><tr><th>स्थानीय तह</th><th>वडा नं.</th><th>च.नं.</th><th>मिति</th><th>Action</th></tr>';
    upperEntries.forEach((e,i)=>{
        html+=`<tr>
        <td><input value="${e.t1}" onchange="upperEntries[${i}].t1=this.value"></td>
        <td><input value="${e.t2}" onchange="upperEntries[${i}].t2=this.value"></td>
        <td><input value="${e.t3}" onchange="upperEntries[${i}].t3=this.value"></td>
        <td><input value="${e.t4}" onchange="upperEntries[${i}].t4=this.value"></td>
        <td><button onclick="upperEntries.splice(${i},1); renderUpperList();">Delete</button></td>
        </tr>`;
    });
    html+='</table>';
    container.innerHTML=html;
    updateUpperTemplate();
}

function updateUpperTemplate(){
    if(upperEntries.length===0){ 
        document.getElementById("templateOutput").innerText=""; 
        return;
    }

    const fy = document.getElementById("t5").value;
    const nepFy = fy.replace(/\d/g,d=>'०१२३४५६७८९'[d]);

    let paragraph = upperEntries.map(e=>{
        return `${e.t1}को ${toNepali(e.t2)} नं. वडा कार्यालयको च.नं. ${toNepali(e.t3)} मिति ${toNepali(e.t4)} गतेको`;
    }).join(" , "); 

    paragraph += ` घरबाटो सिफारिस र जग्गाको वर्गिकरण समेतको आधारमा तपशिलका कित्ता जग्गाहरूको आ.व. ${nepFy} को लागि तपशिल बमोजिम न्युनतम मूल्याङ्कन हुने देखिन्छ ।`;

    const container = document.getElementById("templateOutput");
    container.innerText = paragraph;
    container.style.textAlign = "justify";  
    container.style.wordBreak = "break-word"; 
}

// ----------------- LOWER ENTRY -----------------
function addRow(){
    const district=document.getElementById("district").value;
    const old_vdc=document.getElementById("old_vdc").value;
    const ward=document.getElementById("ward").value;
    const kitta=document.getElementById("kitta").value;
    const area=getArea();
    const road=document.getElementById("road").value;
    const category=document.getElementById("category").value;
    const price=parseFloat(document.getElementById("pricePerRopani").value)||0;
    const minValue=area.ropani*price;
    LOWER_ENTRIES.push(minValue); 
    const table=document.getElementById("resultTable"); table.style.display="table";
    const tbody=table.querySelector("tbody");
    const row=tbody.insertRow();
    const index=tbody.rows.length;
    row.innerHTML=`<td>${toNepali(index)}</td><td>${district}</td><td>${old_vdc}</td><td>${toNepali(ward)}</td><td>${toNepali(kitta)}</td><td class="area" style="white-space:pre-line;">${area.rapdText}</td><td class="road">${road}</td><td class="category">${category}</td><td class="price">${toNepali(price)}</td><td class="price">${toNepali(minValue.toFixed(2))}</td>`;
    updateSum();
}

function addSameGaVISA(){ addRow(); clearLower(false);}
function addNewGaVISA(){ addRow(); clearLower(true);}
function clearLower(newVDC){
    if(newVDC){ document.getElementById("old_vdc").value=""; document.getElementById("ward").value="";}
    document.getElementById("kitta").value="";
    document.getElementById("ropani").value=""; document.getElementById("aana").value="";
    document.getElementById("paisa").value=""; document.getElementById("dam").value="";
    document.getElementById("sqm").value="";
    document.getElementById("road").value=""; document.getElementById("category").value="";
    document.getElementById("pricePerRopani").value="";
}

function updateSum(){
    let sum = LOWER_ENTRIES.reduce((a,b)=>a+b,0);
    document.getElementById("sumText").innerText = "जम्मा : "+numberToNepaliWords(sum);
    document.getElementById("sumValue").innerText = toNepali(sum.toFixed(2));
}

// ----------------- SAVE HISTORY -----------------
function saveHistory(){
    const snapshot={upper:upperEntries.slice(), lower:[]};
    const tbody=document.querySelector("#resultTable tbody");
    for(let tr of tbody.rows){
        snapshot.lower.push(Array.from(tr.cells).map(td=>td.innerText));
    }
    console.log("Saved History:", snapshot);
    alert("History saved to console");
}

</script>

</body>
</html>
