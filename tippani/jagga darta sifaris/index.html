<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ú‡§ó‡•ç‡§ó‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§∏‡§Æ‡§ø‡§§‡§ø‡§ï‡•ã ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏ - acharyasuman4</title>
    <style>
        /* GENERAL RESET */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Kalimati', 'Arial', sans-serif; background-color: #eef2f5; box-sizing: border-box; }
        .main-container { display: flex; height: 100vh; overflow: hidden; }
        
        /* LEFT: FORM */
        .form-pane { flex: 1; min-width: 500px; overflow-y: auto; background: #ffffff; padding: 20px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); border-right: 1px solid #ddd; z-index: 10; }
        
        /* RIGHT: PREVIEW */
        .preview-pane { flex: 1.4; background: #525659; padding: 30px; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; }
        
        /* PAPER */
        #print-preview {
            background: white; width: 210mm; min-height: 297mm; height: auto;
            padding: 25.4mm 12.7mm 25.4mm 31.75mm; /* Margins */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); box-sizing: border-box;
            font-size: 14px; line-height: 1.5; color: #000; margin-bottom: 50px; text-align: justify;
        }

        /* UI ELEMENTS */
        h2.form-header { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 0; }
        h3 { color: #2c3e50; font-size: 15px; margin-top: 15px; border-bottom: 1px solid #eee; background: #f9f9f9; padding: 5px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 3px; color: #444; }
        input[type="text"], select, textarea { width: 100%; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; box-sizing: border-box; font-size: 13px; }
        input:focus, select:focus, textarea:focus { border-color: #3498db; outline: none; background: #f0f8ff; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }

        /* TABLES */
        .input-table, .result-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 5px; }
        .input-table th { background: #f1f1f1; text-align: left; padding: 4px; border: 1px solid #ddd; }
        .input-table td { padding: 2px; border: 1px solid #ddd; }
        .result-table th, .result-table td { border: 1px solid #000; padding: 4px 6px; vertical-align: middle; text-align: center; }
        .result-table th { background-color: #f0f0f0; font-weight: bold; }

        /* UTILS */
        .btn-group { margin-top: 5px; margin-bottom: 15px; }
        .btn { padding: 6px 12px; border: none; border-radius: 3px; cursor: pointer; color: white; margin-right: 5px; font-size: 12px; }
        .btn-green { background-color: #27ae60; } .btn-blue { background-color: #2980b9; } .btn-red { background-color: #c0392b; }
        .btn-print { background-color: #34495e; font-size: 16px; padding: 12px; width: 100%; margin-top: 20px; font-weight: bold; }
        .btn-word { background-color: #2c3e50; font-size: 16px; padding: 12px; width: 100%; margin-top: 10px; font-weight: bold; }
        .bold-text { font-weight: bold; } .hidden { display: none; }
        
        .kitta-box { border: 1px solid #ccc; padding: 10px; background: #fff; margin-top: 5px; max-height: 150px; overflow-y: auto; }
        .kitta-item { display: inline-block; margin-right: 10px; font-size: 12px; }
        .list-item { background: #fff; border: 1px solid #ddd; padding: 8px; margin-bottom: 5px; border-radius: 4px; position: relative; }
        .list-remove { position: absolute; right: 5px; top: 5px; color: red; cursor: pointer; font-weight: bold; }

        @media print {
            .form-pane { display: none !important; }
            .preview-pane { display: block !important; padding: 0 !important; background: white !important; overflow: visible !important; }
            .main-container { display: block !important; height: auto !important; }
            #print-preview { width: 100% !important; height: auto !important; box-shadow: none !important; margin: 0 !important; border: none !important; padding: 0 !important; }
            @page { size: A4; margin: 25.4mm 12.7mm 25.4mm 31.75mm; }
            thead { display: table-header-group; } tr { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="form-pane">
        <h2 class="form-header">‡§ú‡§ó‡•ç‡§ó‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏ ‡§´‡§æ‡§∞‡§Æ</h2>
        
        <div style="background:#e3f2fd; padding:10px; border-radius:5px; margin-bottom:15px; border:1px solid #b3e5fc;">
            <label>‡§®‡§ø‡§µ‡•á‡§¶‡§® ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞:</label>
            <input type="radio" name="req_type" value="‡§¶‡§∞‡•ç‡§§‡§æ" checked onchange="updatePreview()"> ‡§õ‡•Å‡§ü ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ
            <input type="radio" name="req_type" value="‡§®‡§æ‡§Æ‡§∏‡§æ‡§∞‡•Ä ‡§¶‡§∞‡•ç‡§§‡§æ" onchange="updatePreview()" style="margin-left:15px;"> ‡§®‡§æ‡§Æ‡§∏‡§æ‡§∞‡•Ä ‡§¶‡§∞‡•ç‡§§‡§æ
        </div>

        <div class="row form-group">
            <div class="col"><label>‡§¶‡§∞‡•ç‡§§‡§æ ‡§®‡§Ç.:</label><input type="text" id="reg_no" oninput="updatePreview()"></div>
            <div class="col"><label>‡§Æ‡§ø‡§§‡§ø (YYYY.MM.DD):</label><input type="text" id="date" placeholder="‡•®‡•¶‡•Æ‡•®.‡•¶‡•ß.‡•¶‡•®" oninput="updatePreview()"></div>
        </div>

        <div class="form-group">
            <label>‡§µ‡§ø‡§∑‡§Ø:</label>
            <select id="subject_opt" onchange="checkSubject(); updatePreview()">
                <option value="‡§õ‡•Å‡§ü ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§ó‡§∞‡•Ä ‡§ú.‡§ß. ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡•Å‡§∞‡•ç‡§ú‡§æ ‡§™‡§æ‡§â‡§Å ‡•§">‡§õ‡•Å‡§ü ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§ó‡§∞‡•Ä ‡§ú.‡§ß. ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡•Å‡§∞‡•ç‡§ú‡§æ ‡§™‡§æ‡§â‡§Å ‡•§</option>
                <option value="custom">‡§Ö‡§®‡•ç‡§Ø ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</option>
            </select>
            <input type="text" id="subject_custom" class="hidden" style="margin-top:5px;" placeholder="‡§µ‡§ø‡§∑‡§Ø ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" oninput="updatePreview()">
        </div>

        <h3>‡•ß. ‡§®‡§ø‡§µ‡•á‡§¶‡§ï‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£ (‡§¨‡§π‡•Å ‡§®‡§ø‡§µ‡•á‡§¶‡§ï)</h3>
        <div style="background:#f0f4f8; padding:10px; border:1px solid #d1d9e6; border-radius:5px; margin-bottom:10px;">
            <div class="row form-group">
                <div class="col"><label>‡§®‡§æ‡§Æ ‡§•‡§∞:</label><input type="text" id="inp_app_name"></div>
                <div class="col"><label>‡§µ‡§§‡§®:</label><input type="text" id="inp_app_addr"></div>
            </div>
            <div class="row form-group">
                <div class="col"><label>‡§®‡§æ.‡§™‡•ç‡§∞.‡§®‡§Ç.:</label><input type="text" id="inp_app_cit"></div>
                <div class="col"><label>‡§ú‡§æ‡§∞‡•Ä ‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ:</label><input type="text" id="inp_app_dist" value="‡§∏‡§ø‡§®‡•ç‡§ß‡•Å‡§™‡§æ‡§≤‡•ç‡§ö‡•ã‡§ï"></div>
                <div class="col"><label>‡§ú‡§æ‡§∞‡•Ä ‡§Æ‡§ø‡§§‡§ø:</label><input type="text" id="inp_app_date"></div>
            </div>
            <div class="row form-group">
                <div class="col" style="flex:0.4;">
                    <select id="inp_rel1_type" onchange="handleRelChange()"><option value="‡§¨‡§æ‡§¨‡•Å">‡§¨‡§æ‡§¨‡•Å‡§ï‡•ã ‡§®‡§æ‡§Æ</option><option value="‡§™‡§§‡§ø">‡§™‡§§‡§ø‡§ï‡•ã ‡§®‡§æ‡§Æ</option></select>
                </div>
                <div class="col"><input type="text" id="inp_rel1_name"></div>
            </div>
            <div class="row form-group">
                <div class="col" style="flex:0.4;">
                    <select id="inp_rel2_type"><option value="‡§¨‡§æ‡§ú‡•á">‡§¨‡§æ‡§ú‡•á‡§ï‡•ã ‡§®‡§æ‡§Æ</option><option value="‡§∏‡§∏‡•Å‡§∞‡§æ">‡§∏‡§∏‡•Å‡§∞‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ</option></select>
                </div>
                <div class="col"><input type="text" id="inp_rel2_name"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="addApplicant('same')">+ Add (Same Parent)</button>
                <button class="btn btn-green" onclick="addApplicant('new')">+ Add (New Parent)</button>
            </div>
        </div>
        <div id="applicant_list_container"></div>

        <h3>‡•®. ‡§π‡§ï‡§¶‡§æ‡§∞ ‡§µ‡§ø‡§µ‡§∞‡§£ (‡§®‡§æ‡§Æ‡§∏‡§æ‡§∞‡•Ä ‡§≠‡§è‡§Æ‡§æ)</h3>
        <div class="row form-group">
            <div class="col"><label>‡§∏‡§æ‡§µ‡§ø‡§ï ‡§¶‡§∞‡•ç‡§§‡§æ‡§µ‡§æ‡§≤‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ:</label><input type="text" id="old_owner_name" oninput="updateDatalist(); updatePreview()"></div>
            <div class="col"><label>‡§µ‡§§‡§®:</label><input type="text" id="old_owner_addr" oninput="updatePreview()"></div>
        </div>
        <div class="form-group"><label>‡§π‡§ï‡§¶‡§æ‡§∞ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£:</label><input type="text" id="heir_proof" oninput="updatePreview()"></div>

        <label>‡§π‡§ï‡§¶‡§æ‡§∞‡§π‡§∞‡•Å‡§ï‡•ã ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ:</label>
        <table class="input-table" id="heir_table">
            <thead><tr><th width="30%">‡§®‡§æ‡§§‡§æ</th><th>‡§®‡§æ‡§Æ‡§•‡§∞</th><th width="30%">‡§ï‡•à‡§´‡§ø‡§Ø‡§§</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
        <datalist id="person_list"></datalist>
        <div class="btn-group"><button class="btn btn-green" onclick="addHeirRow()">+ Add Row</button></div>
        <div class="form-group"><label>‡§ò. ‡§Ö‡§®‡•ç‡§Ø ‡§π‡§ï‡§¶‡§æ‡§∞‡§≤‡•á ‡§π‡§ï ‡§õ‡•ã‡§°‡•á‡§ï‡•ã‡§Æ‡§æ ‡§®‡§æ‡§Æ:</label><input type="text" id="heir_consent" value="‡§õ‡•à‡§®" oninput="updatePreview()"></div>

        <h3>‡•©. ‡§ú‡§ó‡•ç‡§ó‡§æ‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
        <div class="row form-group">
            <div class="col"><label>‡§∞.‡§®‡§Ç./‡§π‡§æ.‡§®‡§Ç. (‡§è‡§ï‡§≠‡§®‡•ç‡§¶‡§æ ‡§¨‡§¢‡§ø ‡§≠‡§è ‡§ï‡§Æ‡§æ ‡§¶‡§ø‡§è‡§∞):</label><input type="text" id="land_rec_no" oninput="updatePreview()"></div>
        </div>
        <table class="input-table" id="land_table">
            <thead>
                <tr>
                    <th>‡§Æ‡•å‡§ú‡§æ/‡§ó‡§æ.‡§µ‡§ø.‡§∏.</th><th width="40px">‡§µ‡§°‡§æ</th><th width="40px">‡§ï‡§ø.‡§®‡§Ç.</th><th width="50px">‡§ï‡•ç‡§∑‡•á.‡§´.</th>
                    <th>‡§ñ‡§≤‡•ã</th><th>‡§µ‡§ø‡§∞‡§π</th><th>‡§ï‡§ø‡§∏‡§ø‡§Æ</th><th>‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø</th><th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="btn-group">
            <button class="btn btn-blue" onclick="addSameGavisa()">+ Add (Same Gavisa)</button>
            <button class="btn btn-green" onclick="addNewGavisa()">+ Add (New Gavisa)</button>
        </div>

        <h3>‡§Ö‡§®‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
        <div class="form-group"><label>‡•™. ‡•≠ ‡§®‡§Ç. ‡§´‡§æ‡§Å‡§ü‡§µ‡§æ‡§∞‡•Ä ‡§≠‡§ø‡§°‡•ç‡§õ?</label><input type="text" id="q4" value="‡§≠‡§ø‡§°‡•ç‡§õ ‡•§" oninput="updatePreview()"></div>
        <div class="form-group"><label>‡•´. ‡§•‡§™ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£ (‡§´‡§ø‡§≤‡•ç‡§°‡§¨‡•Å‡§ï... ‡§¨‡§æ‡§π‡•á‡§ï):</label><input type="text" id="q5_extra" placeholder="‡§õ‡•à‡§®" oninput="updatePreview()"></div>
        <div class="form-group"><label>‡•¨. ‡§¨‡§æ‡§Å‡§ï‡•Ä ‡§¶‡§∞‡•ç‡§§‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£:</label><input type="text" id="q6" value="‡§õ‡•à‡§®" oninput="updatePreview()"></div>
        <div class="form-group"><label>‡•≠. ‡§™‡§π‡§ø‡§≤‡•á ‡§®‡§ø‡§µ‡•á‡§¶‡§® ‡§¶‡§ø‡§è‡§ï‡•ã ‡§≠‡§è‡§ï‡•ã ‡§≠‡§è‡§ï‡•ã ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡•Ä‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ:</label><input type="text" id="q7" value="‡§õ‡•à‡§®" oninput="updatePreview()"></div>
        <div class="form-group"><label>8. ‡§Æ‡§æ‡§≤‡§™‡•ã‡§§/‡§ß‡§∞‡•å‡§ü‡•Ä:</label><input type="text" id="q8" value="‡§§‡§ø‡§∞‡•ã ‡§Æ‡§ø‡§∏‡§ø‡§≤ ‡§∏‡§Ç‡§≤‡§ó‡•ç‡§® ‡§õ ‡•§ ‡§ß‡§∞‡•å‡§ü‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§õ‡•à‡§®" oninput="updatePreview()"></div>

        <h3>‡•Ø. ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§ï‡•ã ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§§‡§æ</h3>
        <div class="form-group" style="background:#f9f9f9; padding:5px; border:1px solid #ddd;">
            <label>‡§Æ‡•ã‡§π‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£:</label>
            <input type="radio" name="mohi_opt" value="chhaina" checked onchange="toggleMohi()"> ‡§õ‡•à‡§®
            <input type="radio" name="mohi_opt" value="chha" onchange="toggleMohi()"> ‡§õ
            <div id="mohi_section" class="hidden">
                <div style="margin-top:5px; border-bottom:1px dashed #ccc; padding-bottom:5px;">
                    <label>‡§Æ‡•ã‡§π‡•Ä‡§ï‡•ã ‡§≠‡§®‡§æ‡§á (‡§¨‡•Å‡§Å‡§¶‡§æ ‡§®‡§Ç ‡•ß‡•™ ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø):</label>
                    <input type="text" id="mohi_statement" value="‡§õ‡•à‡§®" oninput="updatePreview()">
                </div>
                <div style="background:#fff; border:1px solid #ccc; padding:10px; margin-top:10px;">
                    <label style="color:#2980b9;">‡§®‡§Ø‡§æ‡§Å ‡§Æ‡•ã‡§π‡•Ä ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</label>
                    <input type="text" id="new_mohi_name" placeholder="‡§Æ‡•ã‡§π‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ" style="margin-bottom:5px;">
                    <div style="font-size:11px; margin-bottom:3px; color:#666;">‡§Æ‡•ã‡§π‡•Ä ‡§≤‡§æ‡§ó‡•ç‡§®‡•á ‡§ï‡§ø‡§§‡•ç‡§§‡§æ‡§π‡§∞‡•Å ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:</div>
                    <div id="mohi_kitta_container" class="kitta-box"></div>
                    <button class="btn btn-green" style="margin-top:5px;" onclick="addMohiGroup()">+ Assign Mohi</button>
                </div>
                <div id="mohi_list_display" style="margin-top:10px;"></div>
            </div>
        </div>

        <div class="form-group" style="background:#f9f9f9; padding:5px; border:1px solid #ddd; margin-top:10px;">
            <label>‡§ù‡§ó‡§°‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£:</label>
            <input type="radio" name="jhagada_opt" value="chhaina" checked onchange="toggleJhagada()"> ‡§õ‡•à‡§®
            <input type="radio" name="jhagada_opt" value="chha" onchange="toggleJhagada()"> ‡§õ
            <div id="jhagada_section" class="hidden">
                <div style="font-size:11px; margin-top:3px; color:#666;">‡§ù‡§ó‡§°‡§æ ‡§≠‡§è‡§ï‡§æ ‡§ï‡§ø‡§§‡•ç‡§§‡§æ‡§π‡§∞‡•Å ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:</div>
                <div id="jhagada_kitta_container" class="kitta-box"></div>
            </div>
        </div>

        <div class="form-group" style="background:#f9f9f9; padding:5px; border:1px solid #ddd;">
            <label>‡§´‡§ø‡§≤‡•ç‡§°‡§¨‡•Å‡§ï‡§ï‡•ã ‡§ï‡•à‡§´‡§ø‡§Ø‡§§:</label>
            <div style="font-size:12px; margin-bottom:5px;">
                <input type="radio" name="fb_opt" value="chhaina" checked onchange="toggleFbRemark()"> ‡§õ‡•à‡§®
                <input type="radio" name="fb_opt" value="chha" onchange="toggleFbRemark()"> ‡§õ
            </div>
            <div id="fb_remark_section" class="hidden">
                <input type="text" id="new_fb_remark" placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£‡§É ‡§ù‡§ó‡§°‡§æ ‡§ú‡§®‡§ø‡§è‡§ï‡•ã" style="margin-bottom:5px;">
                <div style="font-size:11px; margin-bottom:3px; color:#666;">‡§≤‡§æ‡§ó‡•ç‡§®‡•á ‡§ï‡§ø‡§§‡•ç‡§§‡§æ‡§π‡§∞‡•Å ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:</div>
                <div id="fb_kitta_container" class="kitta-box"></div>
                <button class="btn btn-green" style="margin-top:5px;" onclick="addFbRemarkGroup()">+ Add Remark</button>
                <div id="fb_remark_list" style="margin-top:10px;"></div>
            </div>
        </div>

        <div class="row form-group">
            <div class="col"><label>‡§Æ‡•ã‡§† ‡§µ‡§ø‡§µ‡§∞‡§£:</label><input type="text" id="moth_desc" value="‡§õ‡•à‡§®" oninput="updatePreview()"></div>
            <div class="col"><label>‡§∞‡•ã‡§ï‡•ç‡§ï‡§æ:</label><input type="text" id="rocca_desc" value="‡§õ‡•à‡§®" oninput="updatePreview()"></div>
        </div>
        <div class="row form-group">
            <div class="col"><label>‡§∏‡§æ‡§µ‡§ø‡§ï ‡§≤‡§ó‡§§:</label><input type="text" id="sabik_desc" value="‡§õ" oninput="updatePreview()"></div>
            <div class="col"><label>‡§≤‡•Å‡§ú‡§∏‡•Ä‡§ü ‡§≠‡§ø‡§°‡•á‡§ï‡•ã:</label><select id="loose_sheet" onchange="updatePreview()"><option value="‡§õ">‡§õ</option><option value="‡§õ‡•à‡§®">‡§õ‡•à‡§®</option></select></div>
        </div>

        <h3>‡•ß‡•¶-‡•®‡•®. ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏ ‡§§‡§•‡§æ ‡§∞‡§æ‡§Ø</h3>
        <div class="form-group"><label>‡•ß‡•¶. ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§§‡§π ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏:</label><textarea rows="2" id="q10" oninput="updatePreview()">‡§®‡§ø‡§µ‡•á‡§¶‡§ï‡§≤‡•á ‡§π‡§ï‡§≠‡•ã‡§ó ‡§ó‡§∞‡•Ä ‡§Ü‡§è‡§ï‡•ã ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§π‡•Å‡§® ‡§õ‡•Å‡§ü ‡§≠‡§è‡§ï‡•ã‡§≤‡•á ‡§®‡§ø‡§Ø‡§Æ‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§ó‡§∞‡•Ä ‡§¶‡§ø‡§®‡•Ç ‡•§</textarea></div>
        <div class="form-group"><label>‡•ß‡•ß. ‡§∏‡§∞‡•ç‡§ú‡§Æ‡§ø‡§®‡§ï‡•ã ‡§≠‡§®‡§æ‡§á:</label><textarea rows="2" id="q11" oninput="updatePreview()">‡§∏‡§æ‡§¨‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§¶‡•á‡§ñ‡§ø‡§ï‡•ã ‡§π‡§ï‡§≠‡•ã‡§ó ‡§≠‡§ø‡§§‡•ç‡§∞‡§ï‡•ã ‡§®‡§Æ‡•ç‡§¨‡§∞‡•Ä ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§Ø‡•Ä ‡§®‡§ø‡§µ‡•á‡§¶‡§ï‡§ï‡§æ ‡§®‡§æ‡§â‡§Å‡§Æ‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§ó‡§∞‡•Ä ‡§¶‡§ø‡§è ‡§´‡§∞‡§ï ‡§™‡§∞‡•ç‡§¶‡•à‡§® ‡•§</textarea></div>
        <div class="form-group"><label>‡•ß‡•®. ‡§∏‡•ç‡§•‡§≤‡§ó‡§§ ‡§®‡•Ä‡§∞‡§ø‡§ï‡•ç‡§∑‡§£:</label><textarea rows="2" id="q12" oninput="updatePreview()">‡§®‡§æ‡§™‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§¨‡§æ‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§´‡§ø‡§≤‡•ç‡§° ‡§™‡•ç‡§∞‡§§‡§ø‡§µ‡•á‡§¶‡§® ‡§Æ‡§ø‡§∏‡§ø‡§≤‡§Æ‡§æ ‡§∏‡§Ç‡§≤‡§ó‡•ç‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡•§</textarea></div>
        <div class="form-group"><label>‡•ß‡•´. ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£:</label><textarea rows="3" id="q15" oninput="updatePreview()">‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§ê‡§≤‡§æ‡§®‡•Ä ‡§™‡§∞‡•ç‡§§‡•Ä ‡§ó‡•Å‡§†‡•Ä ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§¨‡§ø‡§∂‡•á‡§∑‡§ï‡•ã ‡§π‡§ï ‡§≤‡§æ‡§ó‡•ç‡§®‡•á ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§≠‡§è ‡§µ‡§æ ‡§∏‡•ã ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞‡§ï‡§æ ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§∏‡§Æ‡•á‡§§ ‡§®‡§æ‡§™ ‡§®‡§ï‡•ç‡§∏‡§æ ‡§µ‡§æ ‡§≠‡•ã‡§ó ‡§∏‡§Æ‡•á‡§§ ‡§ó‡§∞‡•á‡§ï‡•ã ‡§≠‡§è ‡§¶‡§æ‡§¨‡•Ä ‡§¨‡§ø‡§∞‡•ã‡§ß ‡§ó‡§∞‡•ç‡§®‡•Å ‡§π‡•Å‡§® ‡§≠‡§®‡•Ä ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ø ‡§¶‡•à‡§®‡§ø‡§ï ‡§™‡§§‡•ç‡§∞‡§ø‡§ï‡§æ ‡§∏‡§Æ‡•á‡§§‡§Æ‡§æ ‡•©‡•´ ‡§¶‡§ø‡§®‡•á ‡§π‡§ï‡§¶‡§æ‡§¨‡•Ä ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§® ‡§≠‡§è‡§ï‡•ã ‡•§</textarea></div>
        <div class="form-group"><label>‡•ß‡•Ø. ‡§Ö‡§®‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£:</label><textarea rows="2" id="q19" oninput="updatePreview()">‡§®‡§≠‡§è‡§ï‡•ã</textarea></div>
        <div class="form-group"><label>‡•®‡•ß. ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§ï‡•ã ‡§∞‡§æ‡§Ø:</label><textarea rows="3" id="q21" oninput="updatePreview()">‡§®‡§ø‡§µ‡•á‡§¶‡§ï‡§≤‡•á ‡§¶‡§∞‡•ç‡§§‡§æ‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§ö‡§æ‡§π‡§ø‡§®‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£ ‡§∏‡§æ‡§• ‡§π‡§ï‡§¶‡§æ‡§∞ ‡§∞ ‡§π‡§ï‡§≠‡•ã‡§ó ‡§ñ‡•Å‡§≤‡•Ä ‡§Ü‡§è‡§ï‡•ã ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§®‡§ø‡§ï‡§æ‡§Ø‡§ï‡•ã ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏ ‡§∏‡§æ‡§• ‡§Æ‡§æ‡§ó‡§¶‡§æ‡§¨‡•Ä ‡§≤‡§ø‡§è‡§ï‡•ã ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§®‡§ø‡§µ‡•á‡§¶‡§ï‡§ï‡§æ ‡§®‡§æ‡§â‡§Å‡§Æ‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§π‡•Å‡§®‡•á ‡§¶‡•á‡§ñ‡§ø ‡§™‡•á‡§∂ ‡§≠‡§è‡§ï‡•ã ‡•§</textarea></div>

        <br>
        <button class="btn btn-print" onclick="window.print()">üñ® Print / Save PDF</button>
        <button class="btn btn-word" onclick="exportToWord()">‚¨á Download Word (.doc)</button>
        <br><br>
        <button class="btn btn-red" onclick="resetForm()" style="width:100%; margin-bottom:10px;">‚Üª New Form / Reset</button>
    </div>

    <!-- PREVIEW -->
    <div class="preview-pane">
        <div id="print-preview"></div>
    </div>
</div>

<script>
    // --- GLOBAL VARIABLES ---
    let applicants = []; 
    let mohiGroups = []; 
    let fbRemarkGroups = [];
    const FORM_KEY = 'jagga_darta_fixed_v4'; // New key to clear old corrupted data

    // --- HELPER FUNCTIONS ---
    function joinWithRa(arr) {
        if (!arr || arr.length === 0) return '';
        if (arr.length === 1) return arr[0];
        const last = arr[arr.length - 1];
        const rest = arr.slice(0, -1);
        return rest.join(', ') + ' ‡§∞ ' + last;
    }

    // --- DOM UPDATES ---
    function toggleFbRemark() {
        const val = document.querySelector('input[name="fb_opt"]:checked').value;
        document.getElementById('fb_remark_section').classList.toggle('hidden', val === 'chhaina');
        updateKittaSelectors();
    }
    function addFbRemarkGroup() {
        const text = document.getElementById('new_fb_remark').value;
        if (!text) { alert("‡§ï‡•à‡§´‡§ø‡§Ø‡§§ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç"); return; }
        const selected = [];
        document.querySelectorAll('input[id^="fb_assign_"]:checked').forEach(cb => { selected.push(cb.value); cb.checked = false; });
        if (selected.length === 0) { alert("‡§ï‡§ø‡§§‡•ç‡§§‡§æ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç"); return; }
        fbRemarkGroups.push({ remark: text, kittas: selected });
        document.getElementById('new_fb_remark').value = '';
        renderFbRemarkList();
        updatePreview();
    }
    function renderFbRemarkList() {
        const div = document.getElementById('fb_remark_list'); div.innerHTML = '';
        fbRemarkGroups.forEach((g, i) => {
            const d = document.createElement('div'); d.className = 'list-item';
            d.innerHTML = `<b>${g.remark}</b> (‡§ï‡§ø.‡§®‡§Ç.: ${g.kittas.join(', ')}) <span class="list-remove" onclick="fbRemarkGroups.splice(${i},1); renderFbRemarkList(); updatePreview();">X</span>`;
            div.appendChild(d);
        });
    }

    // --- KITTA SELECTORS (FIXED DUPLICATES) ---
    function updateKittaSelectors() {
        const uniqueKittas = new Set();
        document.querySelectorAll('.l-kit').forEach(input => {
            const val = input.value.trim();
            if(val !== '') uniqueKittas.add(val);
        });
        const kittas = Array.from(uniqueKittas);
        
        renderCheckboxes('mohi_kitta_container', kittas, 'mohi_assign');
        renderCheckboxes('jhagada_kitta_container', kittas, 'jhagada_chk');
        renderCheckboxes('fb_kitta_container', kittas, 'fb_assign');
    }

    function renderCheckboxes(containerId, kittas, prefix) {
        const container = document.getElementById(containerId);
        // Save state
        const checkedValues = new Set();
        container.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => checkedValues.add(cb.value));

        container.innerHTML = '';
        if (kittas.length === 0) { container.innerHTML = '<i>‡§Æ‡§æ‡§•‡§ø ‡§ï‡§ø‡§§‡•ç‡§§‡§æ ‡§®‡§Ç. ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</i>'; return; }
        kittas.forEach(k => {
            const span = document.createElement('span');
            span.className = 'kitta-item';
            const isChecked = checkedValues.has(k) ? 'checked' : '';
            span.innerHTML = `<input type="checkbox" id="${prefix}_${k}" value="${k}" ${isChecked} onchange="updatePreview()"> ${k}`;
            container.appendChild(span);
        });
    }

    // --- INITIALIZATION ---
    window.onload = function () {
        if (!restoreFromLocal()) {
            addHeirRow(true);
            addNewGavisa();
            updateKittaSelectors();
        }
        updatePreview();

        document.querySelector('.form-pane').addEventListener('input', function (e) {
            const target = e.target;
            if (target.type === 'checkbox' || target.type === 'radio') return;
            const val = target.value;
            if (/[0-9]/.test(val)) {
                const start = target.selectionStart; const end = target.selectionEnd;
                target.value = val.replace(/[0-9]/g, m => '‡•¶‡•ß‡•®‡•©‡•™‡•´‡•¨‡•≠‡•Æ‡•Ø'[m]);
                if (target.setSelectionRange) target.setSelectionRange(start, end);
                updatePreview();
                saveToLocal();
            }
        });
    };

    // --- APPLICANT LOGIC ---
    function handleRelChange() {
        const r1 = document.getElementById('inp_rel1_type').value;
        const r2Select = document.getElementById('inp_rel2_type');
        if (r1 === '‡§™‡§§‡§ø') r2Select.value = '‡§∏‡§∏‡•Å‡§∞‡§æ'; else if (r1 === '‡§¨‡§æ‡§¨‡•Å') r2Select.value = '‡§¨‡§æ‡§ú‡•á';
    }
    function addApplicant(mode) {
        const name = document.getElementById('inp_app_name').value;
        if (!name) { alert("‡§®‡§æ‡§Æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§õ"); return; }
        const app = {
            name: name,
            addr: document.getElementById('inp_app_addr').value,
            cit: document.getElementById('inp_app_cit').value,
            dist: document.getElementById('inp_app_dist').value,
            date: document.getElementById('inp_app_date').value,
            rel1T: document.getElementById('inp_rel1_type').value,
            rel1N: document.getElementById('inp_rel1_name').value,
            rel2T: document.getElementById('inp_rel2_type').value,
            rel2N: document.getElementById('inp_rel2_name').value
        };
        applicants.push(app);
        renderApplicantList(); updateDatalist(); updatePreview();

        if (mode === 'new') {
            document.getElementById('inp_app_name').value = '';
            document.getElementById('inp_app_cit').value = '';
            document.getElementById('inp_app_date').value = '';
            document.getElementById('inp_rel1_name').value = '';
            document.getElementById('inp_rel2_name').value = '';
        } else {
            document.getElementById('inp_app_name').value = '';
            document.getElementById('inp_app_cit').value = '';
            document.getElementById('inp_app_date').value = '';
        }
        document.getElementById('inp_app_name').focus();
    }
    function removeApplicant(idx) { applicants.splice(idx, 1); renderApplicantList(); updateDatalist(); updatePreview(); }
    function renderApplicantList() {
        const div = document.getElementById('applicant_list_container'); div.innerHTML = '';
        applicants.forEach((app, i) => {
            const d = document.createElement('div'); d.className = 'list-item';
            d.innerHTML = `<b>${i + 1}. ${app.name}</b> (${app.rel1T}: ${app.rel1N}) <span class="list-remove" onclick="removeApplicant(${i})">X</span>`;
            div.appendChild(d);
        });
    }
    function updateDatalist() {
        const dl = document.getElementById('person_list'); dl.innerHTML = '';
        applicants.forEach(a => { let opt = document.createElement('option'); opt.value = a.name; dl.appendChild(opt); });
        const old = document.getElementById('old_owner_name').value;
        if (old) { let opt = document.createElement('option'); opt.value = old; dl.appendChild(opt); }
    }

    // --- ROWS LOGIC ---
    function getValue(id) { const el = document.getElementById(id); return el ? el.value : ''; }
    function checkSubject() {
        const val = document.getElementById('subject_opt').value;
        const custom = document.getElementById('subject_custom');
        val === 'custom' ? custom.classList.remove('hidden') : custom.classList.add('hidden');
    }
  function addHeirRow(isFirst = false, doFocus = true) {
    const tbody = document.querySelector('#heir_table tbody');
    const tr = document.createElement('tr');
    const remarkVal = isFirst ? '‡§´‡§ø‡§≤‡•ç‡§°‡§¨‡•Å‡§ï‡§ï‡•ã ‡§ú.‡§ß.' : '';
    
    tr.innerHTML = `
        <td><input type="text" class="h-rel" oninput="updatePreview()"></td>
        <td><input type="text" class="h-name" list="person_list" oninput="updatePreview()"></td>
        <td><input type="text" class="h-rem" value="${remarkVal}" oninput="updatePreview()"></td>
        <td style="text-align:center;"><button class="btn btn-red" style="margin:0;" onclick="removeRow(this)">X</button></td>
    `;
    tbody.appendChild(tr);
    
    // Only focus if it is NOT the first row AND doFocus is true
    if (!isFirst && doFocus) { 
        tr.querySelector('.h-rel').focus(); 
        updatePreview(); 
    }
}
    function addLandRowHTML(vdcVal, wardVal) {
        const tbody = document.querySelector('#land_table tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="text" class="l-vdc" value="${vdcVal}" oninput="updateKittaSelectors(); updatePreview()"></td><td><input type="text" class="l-ward" value="${wardVal}" oninput="updatePreview()"></td><td><input type="text" class="l-kit" oninput="updateKittaSelectors(); updatePreview()"></td><td><input type="text" class="l-area" oninput="updatePreview()"></td><td><input type="text" class="l-khalo" oninput="updatePreview()"></td><td><input type="text" class="l-virah" oninput="updatePreview()"></td><td><input type="text" class="l-kisim" oninput="updatePreview()"></td><td><input type="text" class="l-prakriti" value="‡§∞‡•à‡§ï‡§∞" oninput="updatePreview()"></td><td style="text-align:center;"><button class="btn btn-red" style="margin:0;" onclick="removeRow(this)">X</button></td>`;
        tbody.appendChild(tr); return tr;
    }
    function addSameGavisa() {
        const rows = document.querySelectorAll('#land_table tbody tr');
        let lastVdc = '', lastWard = '';
        if (rows.length > 0) { const lastRow = rows[rows.length - 1]; lastVdc = lastRow.querySelector('.l-vdc').value; lastWard = lastRow.querySelector('.l-ward').value; }
        const newRow = addLandRowHTML(lastVdc, lastWard); updateKittaSelectors(); updatePreview(); newRow.querySelector('.l-kit').focus();
    }
function addNewGavisa(doFocus = true) { // Added parameter
        const newRow = addLandRowHTML('', '');
        updateKittaSelectors();
        updatePreview();
        // Only focus if requested (True for buttons, False for page load)
        if(doFocus) newRow.querySelector('.l-vdc').focus(); 
    }    function removeRow(btn) { btn.closest('tr').remove(); updateKittaSelectors(); updatePreview(); }

    function toggleMohi() {
        const val = document.querySelector('input[name="mohi_opt"]:checked').value;
        document.getElementById('mohi_section').classList.toggle('hidden', val === 'chhaina');
        updatePreview();
    }
    function toggleJhagada() {
        const val = document.querySelector('input[name="jhagada_opt"]:checked').value;
        document.getElementById('jhagada_section').classList.toggle('hidden', val === 'chhaina');
        if(val === 'chha') updateKittaSelectors();
        updatePreview();
    }
    function addMohiGroup() {
        const name = document.getElementById('new_mohi_name').value;
        if (!name) { alert("‡§Æ‡•ã‡§π‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç"); return; }
        const selected = [];
        document.querySelectorAll('input[id^="mohi_assign_"]:checked').forEach(cb => { selected.push(cb.value); cb.checked = false; });
        if (selected.length === 0) { alert("‡§ï‡§ø‡§§‡•ç‡§§‡§æ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç"); return; }
        mohiGroups.push({ name: name, kittas: selected });
        document.getElementById('new_mohi_name').value = '';
        renderMohiList(); updatePreview();
    }
    function renderMohiList() {
        const div = document.getElementById('mohi_list_display'); div.innerHTML = '';
        mohiGroups.forEach((g, i) => {
            const d = document.createElement('div'); d.className = 'list-item';
            d.innerHTML = `<b>${g.name}</b> (‡§ï‡§ø.‡§®‡§Ç.: ${g.kittas.join(', ')}) <span class="list-remove" onclick="removeMohiGroup(${i})">X</span>`;
            div.appendChild(d);
        });
    }
    function removeMohiGroup(i) { mohiGroups.splice(i, 1); renderMohiList(); updatePreview(); }

    function calculateSpans(data) {
        if (data.length === 0) return [];
        let spans = data.map(() => ({ vdc: 0, ward: 0, khalo: 0, owner9a: 0, action9b: 0 }));
        const merge = (key) => {
            let p = 0;
            while (p < data.length) {
                let count = 1;
                for (let next = p + 1; next < data.length; next++) { if (data[next][key] === data[p][key]) count++; else break; }
                spans[p][key] = count; p += count;
            }
        };
        merge('vdc');
        let p = 0;
        while (p < data.length) {
            let count = 1;
            for (let next = p + 1; next < data.length; next++) { if (data[next].vdc === data[p].vdc && data[next].ward === data[p].ward) count++; else break; }
            spans[p].ward = count; p += count;
        }
        p = 0;
        while (p < data.length) {
            let count = 1;
            for (let next = p + 1; next < data.length; next++) { if (data[next].vdc === data[p].vdc && data[next].khalo === data[p].khalo) count++; else break; }
            spans[p].khalo = count; p += count;
        }
        merge('owner9a'); merge('action9b');
        return spans;
    }

    // --- PREVIEW LOGIC ---
// --- PREVIEW LOGIC ---
    function updatePreview() {
        const typeVal = document.querySelector('input[name="req_type"]:checked').value;
        const isNamsari = (typeVal === '‡§®‡§æ‡§Æ‡§∏‡§æ‡§∞‡•Ä ‡§¶‡§∞‡•ç‡§§‡§æ');
        const typeText = typeVal;
        const date = getValue('date'); const regNo = getValue('reg_no');
        let subject = getValue('subject_opt');
        if (subject === 'custom') subject = getValue('subject_custom');

        let applicantTableHTML = '';
        let applicantNames = [];
        if (applicants.length > 0) {
            applicants.forEach(a => applicantNames.push(a.name));
            let sn = 1; let lastRelKey = '';
            applicantTableHTML = `<table class="result-table">`;
            applicants.forEach(app => {
                const currentRelKey = `${app.rel1T}-${app.rel1N}-${app.rel2N}`;
                if (currentRelKey !== lastRelKey) {
                    const h1 = (app.rel1T === '‡§™‡§§‡§ø') ? '‡§™‡§§‡§ø‡§ï‡•ã ‡§®‡§æ‡§Æ' : '‡§¨‡§æ‡§¨‡•Å‡§ï‡•ã ‡§®‡§æ‡§Æ';
                    const h2 = (app.rel2T === '‡§∏‡§∏‡•Å‡§∞‡§æ') ? '‡§∏‡§∏‡•Å‡§∞‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ' : '‡§¨‡§æ‡§ú‡•á‡§ï‡•ã ‡§®‡§æ‡§Æ';
                    applicantTableHTML += `<tr><th>‡§ï‡•ç‡§∞.‡§∏.</th><th>‡§®‡§ø‡§µ‡•á‡§¶‡§ï‡§ï‡•ã ‡§®‡§æ‡§Æ</th><th>‡§µ‡§§‡§®</th><th>‡§®‡§æ.‡§™‡•ç‡§∞.‡§®‡§Ç./‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ/‡§Æ‡§ø‡§§‡§ø</th><th>${h1}</th><th>${h2}</th></tr>`;
                    lastRelKey = currentRelKey;
                }
                applicantTableHTML += `<tr><td>${sn}</td><td>${app.name}</td><td>${app.addr}</td><td>${app.cit}, ${app.dist}, ${app.date}</td><td>${app.rel1N}</td><td>${app.rel2N}</td></tr>`;
                sn++;
            });
            applicantTableHTML += `</table>`;
        } else { applicantTableHTML = '<i>‡§®‡§ø‡§µ‡•á‡§¶‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ‡•à‡§®</i>'; }

        const firstAppName = applicants.length > 0 ? applicants[0].name : '';
        const displayOldOwner = getValue('old_owner_name') ? (getValue('old_owner_addr') ? getValue('old_owner_addr') + ' ‡§¨‡§∏‡•ç‡§®‡•á ' + getValue('old_owner_name') : getValue('old_owner_name')) : '';

        let heirTableRows = '';
        let hasManualHeirs = false;
        document.querySelectorAll('.h-rel').forEach((rel, index) => {
            const hName = document.querySelectorAll('.h-name')[index].value;
            const hRem = document.querySelectorAll('.h-rem')[index].value;
            if (hName || rel.value) {
                hasManualHeirs = true;
                const combinedName = hRem ? `${hName} - ${hRem}` : hName;
                heirTableRows += `<tr><td>${rel.value}</td><td>${combinedName}</td></tr>`;
            }
        });
        if (hasManualHeirs && applicantNames.length > 0) {
            heirTableRows += `<tr><td>‡§∏‡•ç‡§µ‡§Ø‡§Æ‡•ç</td><td>${applicantNames.join(', ')} - ‡§®‡§ø‡§µ‡•á‡§¶‡§ï</td></tr>`;
        }

        const lVdcs = document.querySelectorAll('.l-vdc');
        const lWards = document.querySelectorAll('.l-ward');
        const lKits = document.querySelectorAll('.l-kit');
        const lAreas = document.querySelectorAll('.l-area');
        const lKhalos = document.querySelectorAll('.l-khalo');
        const lVirahs = document.querySelectorAll('.l-virah');
        const lKisims = document.querySelectorAll('.l-kisim');
        const lPrakritis = document.querySelectorAll('.l-prakriti');

        const isMohiEnabled = document.querySelector('input[name="mohi_opt"]:checked').value === 'chha';
        const isJhagadaEnabled = document.querySelector('input[name="jhagada_opt"]:checked').value === 'chha';

        let landData = [];
        for (let i = 0; i < lVdcs.length; i++) {
            const kit = lKits[i].value.trim();
            let rowMohi = '‡§õ‡•à‡§®';
            if (isMohiEnabled && kit) {
                const grp = mohiGroups.find(g => g.kittas.includes(kit));
                if (grp) rowMohi = grp.name;
            }
            let rowJhagada = '‡§õ‡•à‡§®';
            if (isJhagadaEnabled && kit) {
                const chk = document.getElementById(`jhagada_chk_${kit}`);
                if (chk && chk.checked) rowJhagada = '‡§õ';
            }
            let rowFbRemark = '‡§õ‡•à‡§®';
            const fbGrp = fbRemarkGroups.find(g => g.kittas.includes(kit));
            if (fbGrp) rowFbRemark = fbGrp.remark;

            landData.push({
                vdc: lVdcs[i].value, ward: lWards[i].value, kit: kit,
                area: lAreas[i].value, khalo: lKhalos[i].value, virah: lVirahs[i].value,
                kisim: lKisims[i].value, prakriti: lPrakritis[i].value,
                mohi: rowMohi, jhagada: rowJhagada,
                owner9a: isNamsari ? getValue('old_owner_name') : firstAppName,
                fbRemark: rowFbRemark,
                action9b: (getValue('q7') === '‡§õ‡•à‡§®' ? '‡§Æ‡§ø‡§∏‡§ø‡§≤ ‡§∏‡§Ç‡§≤‡§ó‡•ç‡§® ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§π‡§∞‡•Ç‡§Æ‡§æ ‡§¶‡•á‡§ñ‡§ø‡§®‡•ç‡§®' : '‡§¶‡•á‡§ñ‡§ø‡§®‡•ç‡§õ')
            });
        }

        const spans = calculateSpans(landData);
        let sec3Rows = '', sec9aRows = '', sec9bRows = '';
        const landRec = getValue('land_rec_no');

        landData.forEach((row, i) => {
            const sp = spans[i];
            sec3Rows += '<tr>';
            if (sp.vdc > 0) {
                sec3Rows += `<td rowspan="${sp.vdc}">${row.vdc}</td>`;
                if (i === 0) {
                    const safeLandRec = landRec ? landRec.replace(/,/g, ', ') : '';
                    sec3Rows += `<td rowspan="${landData.length}" style="width:80px; word-wrap:break-word; white-space:normal;">${safeLandRec}</td>`;
                }
            }
            if (sp.khalo > 0) sec3Rows += `<td rowspan="${sp.khalo}">${row.khalo}</td>`;
            sec3Rows += `<td>${row.prakriti}</td>`;
            if (sp.vdc > 0) sec3Rows += `<td rowspan="${sp.vdc}">${row.vdc}</td>`;
            if (sp.ward > 0) sec3Rows += `<td rowspan="${sp.ward}">${row.ward}</td>`;
            sec3Rows += `<td>${row.kit}</td><td>${row.area}</td><td>${row.virah} ${row.kisim}</td></tr>`;

            sec9aRows += '<tr>';
            if (sp.vdc > 0) sec9aRows += `<td rowspan="${sp.vdc}">${row.vdc}</td>`;
            sec9aRows += `<td>${row.ward} / ${row.kit}</td>`;
            if (sp.owner9a > 0) sec9aRows += `<td rowspan="${sp.owner9a}">${row.owner9a}</td>`;
            sec9aRows += `<td>${row.mohi}</td><td>${row.fbRemark}</td>`;
            sec9aRows += `<td>‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§õ‡•à‡§®</td><td>${row.jhagada}</td><td>${row.virah} ${row.kisim}</td></tr>`;

            sec9bRows += '<tr>';
            if (sp.vdc > 0) sec9bRows += `<td rowspan="${sp.vdc}">${row.vdc}</td>`;
            sec9bRows += `<td>${row.ward} / ${row.kit}</td><td>${getValue('moth_desc')}</td>`;
            sec9bRows += `<td>${getValue('rocca_desc')}</td><td>${getValue('sabik_desc')}</td>`;
            if (sp.action9b > 0) sec9bRows += `<td rowspan="${sp.action9b}">${row.action9b}</td>`;
            sec9bRows += `<td></td></tr>`;
        });

        let recText = "";
        if (landData.length > 0) {
            let vdcMap = {};
            landData.forEach(d => {
                if (!d.vdc) return;
                if (!vdcMap[d.vdc]) vdcMap[d.vdc] = {};
                if (!vdcMap[d.vdc][d.ward]) vdcMap[d.vdc][d.ward] = [];
                if (d.kit) vdcMap[d.vdc][d.ward].push(d.kit);
            });
            let vdcParts = [];
            for (let vdc in vdcMap) {
                let wardParts = [];
                for (let ward in vdcMap[vdc]) {
                    let kits = vdcMap[vdc][ward];
                    wardParts.push(`‡§µ‡§°‡§æ ‡§®‡§Ç. <b>${ward}</b> ‡§ï‡•ã ‡§ï‡§ø.‡§®‡§Ç. <b>${joinWithRa(kits)}</b>`);
                }
                vdcParts.push(`‡§∏‡§æ‡§¨‡§ø‡§ï <b>${vdc}</b> ‡§ó‡§æ.‡§µ‡§ø.‡§∏. ${joinWithRa(wardParts)}`);
            }
            recText = joinWithRa(vdcParts);
        }

        const replacer = (text) => text.replace(/‡§¶‡§∞‡•ç‡§§‡§æ|‡§¶‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ‡§∏‡§æ‡§∞‡•Ä/g, typeText);
        const mohiStatement = isMohiEnabled ? getValue('mohi_statement') : '‡§õ‡•à‡§®';

        const html = `
            <div style="font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 16px;">‡§ú‡§ó‡•ç‡§ó‡§æ‡§¶‡§∞‡•ç‡§§‡§æ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏ ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§≠‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á ‡§´‡§æ‡§∞‡§Æ</div>
            <div class="bold-text" style="margin-bottom: 10px;">‡§Æ‡§æ‡§≤‡§™‡•ã‡§§ ‡§®‡§ø‡§Ø‡§Æ‡§æ‡§µ‡§≤‡•Ä ‡•®‡•¶‡•©‡•¨ ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Æ ‡•™‡§ñ ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡•ã ‡§ú‡§ó‡•ç‡§ó‡§æ‡§¶‡§∞‡•ç‡§§‡§æ ‡§∏‡§Æ‡§ø‡§§‡§ø‡§ï‡•ã ‡§¨‡•à‡§†‡§ï‡§ï‡•ã ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø</div>
            <div class="bold-text" style="margin-bottom: 10px;">‡§®‡§ø‡§µ‡•á‡§¶‡§®‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø ‡§∞ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§®‡§Æ‡•ç‡§¨‡§∞‡§É ${date} , ${regNo}</div>
            <div class="bold-text" style="margin-bottom: 10px;">‡§®‡§ø‡§µ‡•á‡§¶‡§®‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£‡§É ${subject}</div>
            <div class="bold-text" style="margin-bottom: 5px;">‡•ß. ‡§®‡§ø‡§µ‡•á‡§¶‡§ï‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£‡§É-</div>
            <div style="margin-bottom: 10px;">${applicantTableHTML}</div>
            <div class="bold-text" style="margin-bottom: 5px;">‡•®. ‡§π‡§ï‡§¶‡§æ‡§∞‡§≤‡•á ‡§¶‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ‡§∏‡§æ‡§∞‡•Ä ‡§Æ‡§æ‡§ó ‡§ó‡§∞‡•á‡§ï‡•ã‡§Æ‡§æ‡§É</div>
            <div style="margin-left: 15px; margin-bottom: 10px;">
                <b>‡§ï. ‡§∏‡§æ‡§µ‡§ø‡§ï ‡§¶‡§∞‡•ç‡§§‡§æ‡§µ‡§æ‡§≤‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§•‡§∞ ‡§µ‡§§‡§®‡§É-</b>  ${displayOldOwner}<br>
                <b>‡§ñ. ‡§π‡§ï‡§¶‡§æ‡§∞ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§É-</b> ${getValue('heir_proof')}<br>
                <div style="margin-top:5px;"><b> ‡§ó. ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§¨‡§æ‡§ü ‡§¶‡•á‡§ñ‡§ø‡§è‡§ï‡•ã ‡§π‡§ï‡§¶‡§æ‡§∞‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£‡§É</b> <br>
                <table class="result-table" style="width:100%; margin-top:5px;"><tr><th width="30%">‡§®‡§æ‡§§‡§æ</th><th>‡§®‡§æ‡§Æ‡§•‡§∞</th></tr>${heirTableRows}</table></div>
                <b>‡§ò. ‡§ß‡•à‡§∞‡•à ‡§π‡§ï‡§¶‡§æ‡§∞ ‡§≠‡§à ‡§ï‡•á‡§π‡•Ä‡§ï‡§æ ‡§®‡§æ‡§Æ‡§Æ‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§ó‡§∞‡•ç‡§® ‡§Æ‡§æ‡§ó ‡§≠‡§è‡§ï‡•ã‡§Æ‡§æ ‡§ï-‡§ï‡§∏‡§ï‡•ã ‡§®‡§æ‡§Æ‡§Æ‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§®‡•á ‡§π‡•ã ‡§∏‡•ã ‡§∞ ‡§Ö‡§∞‡•Ç ‡§π‡§ï‡§¶‡§æ‡§∞‡§ï‡•ã ‡§Æ‡§®‡•ç‡§ú‡•Å‡§∞‡•Ä ‡§õ ‡§õ‡•à‡§® ? ‡§≠‡§è‡§ï‡•ã ‡§≠‡§è ‡§ï-‡§ï‡§∏‡§ï‡•ã ‡§ñ‡•Å‡§≤‡§æ‡§â‡§®‡•á‡§É- </b><br>- ${getValue('heir_consent')}
            </div>
            <div class="bold-text" style="margin-bottom: 5px;">‡•©. ‡§¶‡§∞‡•ç‡§§‡§æ ‡§Æ‡§æ‡§ó ‡§≠‡§è‡§ï‡•ã ‡§ú‡§ó‡•ç‡§ó‡§æ‡§ï‡•ã ‡§®‡§æ‡§™‡•Ä ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£‡§É-</div>
            <table class="result-table">
                <thead><tr><th rowspan="2">‡§Æ‡•å‡§ú‡§æ</th><th rowspan="2" style="min-width:100px;"><span style="white-space:nowrap;">‡§∞.‡§®‡§Ç., ‡§π‡§æ.‡§®‡§Ç.</span><br>‡§∞ ‡§™‡•ã‡§§‡§æ ‡§®‡§Ç.</th><th rowspan="2">‡§ñ‡§≤‡•ã</th><th rowspan="2">‡§∞‡§æ‡§ú ‡§ó‡•Å‡§†‡•Ä, ‡§®‡§ø‡§ú‡•Ä ‡§ó‡•Å‡§†‡•Ä ‡§µ‡§ø‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§π‡•ã?</th><th colspan="5" style="text-align:center">‡§ú‡§ó‡•ç‡§ó‡§æ‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£</th></tr><tr><th>‡§™‡§û‡•ç‡§ö‡§æ‡§Ø‡§§</th><th>‡§µ‡§°‡§æ ‡§®‡§Ç.</th><th>‡§ï‡§ø.‡§®‡§Ç.</th><th>‡§ï‡•ç‡§∑‡•á.‡§´.</th><th>‡§µ‡§ø‡§∞‡§π</th></tr></thead>
                <tbody>${sec3Rows}</tbody>
            </table>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 8px;">‡•™. ‡•≠ ‡§®‡§Ç. ‡§´‡§æ‡§Å‡§ü‡§µ‡§æ‡§∞‡•Ä‡§Æ‡§æ ‡§â‡§ï‡•ç‡§§ ‡§∏‡§æ‡§µ‡§ø‡§ï‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§ø‡§°‡•ç‡§õ ‡§≠‡§ø‡§°‡•ç‡§¶‡•à‡§® ?</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${getValue('q4')}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 8px;">‡•´. ‡§â‡§ï‡•ç‡§§ ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§¶‡§∞‡•ç‡§§‡§æ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§ï‡•á ‡§ï‡§∏‡•ç‡§§‡•ã ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£ ‡§™‡•á‡§∂ ‡§≠‡§è‡§ï‡•ã ‡§õ?</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ‡§´‡§ø‡§≤‡•ç‡§°‡§¨‡•Å‡§ï, ‡§∏‡§æ‡§¨‡§ø‡§ï ‡§≤‡§ó‡§§, ‡§∏‡§æ‡§¨‡§ø‡§ï ‡§§‡§ø‡§∞‡•ã‡§ï‡•ã ‡§∞‡§∏‡§ø‡§¶, ‡•ß ‡§∞ ‡•®‡§®‡§Ç. ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø ${getValue('q5_extra') ? ', ' + getValue('q5_extra') : ''} ‡§∏‡§Æ‡•á‡§§ ‡•§</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 8px;">‡•¨. ‡§∏‡§æ‡§µ‡§ø‡§ï ‡§≤‡§ó‡§§‡§ï‡•ã ‡§ú‡§ó‡•ç‡§ó‡§æ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ï‡§§‡§ø ‡§¶‡§∞‡•ç‡§§‡§æ ‡§≠‡§Ø‡•ã ‡§∞ ‡§ï‡§§‡§ø ‡§¶‡§∞‡•ç‡§§‡§æ ‡§π‡•Å‡§® ‡§¨‡§æ‡§Å‡§ï‡•Ä ‡§õ ‡§≠‡§®‡•Ä ‡§®‡§ø‡§µ‡•á‡§¶‡§ï‡§≤‡•á ‡§ñ‡•Å‡§≤‡§æ‡§è‡§ï‡•ã ‡§õ ?</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${getValue('q6')}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 8px;">‡•≠. ‡§™‡§π‡§ø‡§≤‡•á ‡§®‡§ø‡§µ‡•á‡§¶‡§® ‡§¶‡§ø‡§è‡§ï‡•ã ‡§≠‡§è ‡§≠‡§è‡§ï‡•ã ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡•Ä‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ ?</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${getValue('q7')}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 8px;">‡•Æ. ‡§¶‡§∞‡•ç‡§§‡§æ ‡§Æ‡§æ‡§ó ‡§≠‡§è‡§ï‡•ã ‡§ú‡§ó‡•ç‡§ó‡§æ‡§ï‡•ã ‡§ï‡•Å‡§® ‡§∏‡§æ‡§≤ ‡§∏‡§Æ‡•ç‡§Æ‡§ï‡•ã ‡§Æ‡§æ‡§≤‡§™‡•ã‡§§ ‡§¨‡•Å‡§ù‡§æ‡§è‡§ï‡•ã ‡§õ ‡§∞ ‡§ï‡•Å‡§® ‡§∏‡§æ‡§≤ ‡§¶‡•á‡§ñ‡§ø‡§ï‡•ã ‡§Æ‡§æ‡§≤‡§™‡•ã‡§§ ‡§¨‡•Å‡§ù‡§æ‡§â‡§® ‡§¨‡§æ‡§Å‡§ï‡•Ä ‡§õ ‡§≠‡§®‡•Ä ‡§®‡§ø‡§µ‡•á‡§¶‡§ï‡§≤‡•á ‡§ñ‡•Å‡§≤‡§æ‡§è‡§ï‡•ã ‡§õ ? ‡§ß‡§∞‡•å‡§ü‡•Ä ‡§∞‡§π‡•á‡§ï‡•ã ‡§≠‡§è ‡§ï‡•Å‡§® ‡§∏‡§æ‡§≤ ‡§∏‡§Æ‡•ç‡§Æ‡§ï‡•ã ‡§ß‡§∞‡•å‡§ü‡•Ä ‡§ï‡§π‡§æ‡§Å ‡§∞‡§π‡•á‡§ï‡•ã ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£ ‡§ï‡•á ‡§™‡•á‡§∂ ‡§õ ?</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${getValue('q8')}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 5px;">‡•Ø. ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§ï‡•ã ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§§‡§æ ‡§≠‡§ø‡§°‡§æ‡§è‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£‡§É-</div>
                <div style="margin-left: 10px;"><b>‡§ï. ‡§´‡§ø‡§≤‡•ç‡§°‡§¨‡•Å‡§ï‡§¨‡§æ‡§ü ‡§¶‡•á‡§ñ‡§ø‡§è‡§ï‡•ã‡§É-</b></div>
                <table class="result-table"><thead><tr><th>‡§™‡§û‡•ç‡§ö‡§æ‡§Ø‡§§</th><th>‡§µ‡§°‡§æ ‡§®‡§Ç./‡§ï‡§ø.‡§®‡§Ç.</th><th>‡§ú‡§ó‡•ç‡§ó‡§æ‡§ß‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§•‡§∞</th><th>‡§Æ‡•ã‡§π‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ, ‡§•‡§∞</th><th>‡§ï‡•à‡§´‡§ø‡§Ø‡§§ ‡§µ‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ</th><th>‡§´‡§ø‡§≤‡•ç‡§°‡§¨‡•Å‡§ï ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§ó‡§∞‡•ç‡§®‡•á</th><th>‡§ù‡§ó‡§°‡§æ ‡§ú‡§®‡§æ‡§è‡§ï‡•ã ‡§õ ‡§õ‡•à‡§®</th><th>‡§µ‡§ø‡§∞‡§π/‡§ï‡§ø‡§∏‡§ø‡§Æ</th></tr></thead><tbody>${sec9aRows}</tbody></table>
            </div>

            <div class="keep-together">
                <div style="margin-left: 10px;"><b>‡§ñ. ‡§Ö‡§®‡•ç‡§Ø ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§§‡§æ ‡§≠‡§ø‡§°‡§æ‡§è‡§ï‡•ã‡§É-</b></div>
                <table class="result-table"><thead><tr><th>‡§™‡§û‡•ç‡§ö‡§æ‡§Ø‡§§</th><th>‡§µ‡§°‡§æ ‡§®‡§Ç./‡§ï‡§ø.‡§®‡§Ç.</th><th>‡§Æ‡•ã‡§† ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§§‡§æ‡§¨‡§æ‡§ü ‡§¶‡•á‡§ñ‡§ø‡§è‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§∞‡•ã‡§ï‡•ç‡§ï‡§æ ‡§õ/‡§õ‡•à‡§®?</th><th>‡§∏‡§æ‡§µ‡§ø‡§ï ‡§≤‡§ó‡§§ ‡§≠‡§ø‡§°‡•á‡§ï‡•ã ‡§õ/‡§õ‡•à‡§®</th><th>‡§Ö‡§∞‡•Ç ‡§ï‡§æ‡§∞‡§¨‡§æ‡§π‡•Ä ‡§µ‡§æ ‡§Æ‡•Å‡§¶‡•ç‡§¶‡§æ ‡§ö‡§≤‡•á‡§ï‡•ã ‡§¶‡•á‡§ñ‡§ø‡§®‡•ç‡§õ/ ‡§¶‡•á‡§ñ‡§ø‡§®‡•ç‡§®</th><th>‡§Ö‡§®‡•ç‡§Ø ‡§µ‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ</th></tr></thead><tbody>${sec9bRows}</tbody></table>
                <div class="bold-text" style="margin-left: 10px; margin-bottom:8px;">‡§ó. ‡§≤‡•Å‡§ú‡§∏‡•Ä‡§ü ‡§≠‡§ø‡§°‡•á‡§ï‡•ã ‡§õ/‡§õ‡•à‡§® ? - <span style="font-weight:normal">${getValue('loose_sheet')}</span></div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 5px;">‡•ß‡•™. ‡§´‡§ø‡§≤‡•ç‡§°‡§¨‡•Å‡§ï‡§Æ‡§æ ‡§¶‡•á‡§ñ‡§ø‡§è‡§ï‡•ã ‡§Æ‡•ã‡§π‡•Ä ‡§¨‡•Å‡§ù‡§ø‡§è‡§ï‡•ã ‡§≠‡§è ‡§Æ‡•ã‡§π‡•Ä‡§ï‡•ã ‡§≠‡§®‡§æ‡§á‡§É</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${mohiStatement}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 5px;">‡•ß‡•¶. ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø‡§§ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§§‡§π‡§ï‡•ã ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${replacer(getValue('q10'))}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 5px;">‡•ß‡•ß. ‡§∏‡§∞‡•ç‡§ú‡§Æ‡§ø‡§®‡§ï‡•ã ‡§≠‡§®‡§æ‡§á‡§É</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${getValue('q11')}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 5px;">‡•ß‡•®. ‡§∏‡•ç‡§•‡§≤‡§ó‡§§ ‡§®‡•Ä‡§∞‡§ø‡§ï‡•ç‡§∑‡§£ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã‡§Æ‡§æ ‡§∏‡•ç‡§•‡§≤‡§ó‡§§ ‡§®‡•Ä‡§∞‡§ø‡§ï‡•ç‡§∑‡§£‡§¨‡§æ‡§ü ‡§¶‡•á‡§ñ‡§ø‡§è‡§ï‡•ã ‡§ú‡§ó‡•ç‡§ó‡§æ‡§ï‡•ã ‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§É-</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${getValue('q12')}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 5px;">‡•ß‡•´. ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§∏‡•Ç‡§ö‡§®‡§æ‡§ï‡•ã ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∞ ‡§¶‡§æ‡§¨‡•Ä ‡§™‡§∞‡•á ‡§®‡§™‡§∞‡•á‡§ï‡•ã‡§É</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${getValue('q15')}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 5px;">‡•ß‡•Ø. ‡§Ö‡§®‡•ç‡§Ø ‡§ï‡•á‡§π‡•Ä ‡§ñ‡•Å‡§≤‡§æ‡§â‡§®‡•Å‡§™‡§∞‡•ç‡§®‡•á ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§è ‡§ñ‡•Å‡§≤‡§æ‡§â‡§®‡•á</div>
                <div style="margin-left: 20px; margin-bottom:8px;">- ${getValue('q19')}</div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-top: 15px; margin-bottom: 25px;">‡•®‡•¶. ‡§™‡•á‡§∂ ‡§≠‡§è‡§ï‡•ã ‡§Æ‡§ø‡§∏‡§ø‡§≤ ‡§∏‡§Ç‡§∞‡§ï‡•ç‡§∑‡§£ ‡§ï‡§æ‡§ó‡§ú‡§æ‡§§ ‡§∏‡§¨‡•Å‡§§ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£ ‡§§‡§•‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§ï‡•ã ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§§‡§æ ‡§∏‡§Æ‡•á‡§§ ‡§≠‡§ø‡§°‡•á‡§ï‡•ã ‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§ï‡•ã ‡§π‡•ã ‡§≠‡§®‡•Ä ‡§∏‡§π‡•Ä ‡§ó‡§∞‡•ç‡§®‡•á ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä‡§É</div>
                <div style="width: 200px; border-bottom: 1px none black; margin-bottom: 5px;"></div><div></div>
            </div>

            <div class="keep-together">
                <div class="bold-text" style="margin-bottom: 5px; margin-top: 10px;">‡•®‡•ß. ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§ï‡•ã ‡§∞‡§æ‡§Ø‡§É-</div>
                <div style="margin-left: 20px; margin-bottom:8px;">${replacer(getValue('q21'))}</div>
            </div>

            <div class="bold-text" style="margin-bottom: 5px;">‡•®‡•®. ‡§∏‡§Æ‡§ø‡§§‡§ø‡§ï‡•ã ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏‡§É-</div>
            <div style="text-align: justify; margin-bottom: 30px;">‡§Æ‡§ø‡§∏‡§ø‡§≤ ‡§∏‡§æ‡§• ‡§∏‡§Ç‡§≤‡§ó‡•ç‡§® ‡§´‡§ø‡§≤‡•ç‡§°‡§¨‡•Å‡§ï, ‡§∏‡§æ‡§¨‡§ø‡§ï ‡§≤‡§ó‡§§, ‡§∏‡§æ‡§¨‡§ø‡§ï ‡§§‡§ø‡§∞‡•ã‡§ï‡•ã ‡§¶‡§∞‡§™‡§ø‡§† ‡§∞‡§∏‡§ø‡§¶, ‡•ß ‡§®‡§Ç. ‡§∞ ‡•® ‡§®‡§Ç. ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§ï‡§æ ‡§´‡§æ‡§∞‡§Æ, ‡§ï‡§ø‡§ü‡§æ‡§®‡•Ä ‡§π‡§ï‡§¶‡§æ‡§∞ ‡§∞ ‡§π‡§ï‡§≠‡•ã‡§ó ‡§ñ‡•Å‡§≤‡•á‡§ï‡•ã ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§®‡§ø‡§ï‡§æ‡§Ø‡§ï‡•ã ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏, ${getValue('q5_extra') ? getValue('q5_extra') + ',' : ''} ‡§π‡§ï‡§¶‡§æ‡§¨‡•Ä ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡•©‡•´ ‡§¶‡§ø‡§®‡•á ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§∏‡•Ç‡§ö‡§®‡§æ, ‡§∏‡•ã‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡•Å‡§ï‡•ç‡§§‡§æ‡§® ‡§π‡•Å‡§Å‡§¶‡§æ ‡§ï‡•ã‡§π‡•Ä ‡§ï‡§∏‡•à‡§ï‡•ã ‡§™‡§®‡§ø ‡§®‡§™‡§∞‡•á‡§ï‡•ã ‡§¶‡§æ‡§¨‡•Ä ‡§µ‡§ø‡§∞‡•ã‡§ß, ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§ï‡•ã ‡§§‡§∞‡•ç‡§´‡§¨‡§æ‡§ü ‡§¨‡•Å‡§ù‡§ø‡§è‡§ï‡•ã ‡§∏‡•ç‡§•‡§≤‡§ó‡§§ ‡§∏‡§∞‡•ç‡§ú‡§Æ‡§ø‡§® ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏‡§¨‡§æ‡§ü ‡§∏‡§Æ‡•á‡§§ ‡§®‡§ø‡§µ‡•á‡§¶‡§ï <b>${firstAppName} ${applicants.length > 1 ? '‡§∏‡§Æ‡•á‡§§' : ''}</b> ‡§π‡§ï‡§¶‡§æ‡§∞ ‡§π‡•Å‡§® ‡§≠‡§®‡•ç‡§®‡•á ‡§ï‡•Å‡§∞‡§æ‡§Æ‡§æ ‡§Æ‡§§‡•à‡§ï‡•ç‡§Ø ‡§∞‡§π‡•á‡§ï‡•ã ‡§¶‡•á‡§ñ‡§ø‡§è‡§ï‡•ã ‡§π‡•Å‡§Å‡§¶‡§æ ‡§®‡§ø‡§ú‡§ï‡§æ ‡§®‡§æ‡§â‡§Å‡§Æ‡§æ ${recText} ‡§ï‡•ã ‡§ú‡§ó‡•ç‡§ó‡§æ ${typeText} ‡§ó‡§∞‡•Ä ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§§‡§æ ‡§™‡•Å‡§∞‡•ç‡§ú‡§æ ‡§ï‡§æ‡§Ø‡§Æ ‡§ó‡§∞‡§ø‡§¶‡§ø‡§® ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§∏‡§π‡§ø‡§§ ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏ ‡§ó‡§∞‡§ø‡§Ø‡•ã ‡•§</div>
            
            <table style="width:100%; border:none; margin-top:30px;"><tr><td style="border:none; text-align:center; vertical-align:top;">...........................<br>‡§Æ‡§æ‡§≤‡§™‡•ã‡§§ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§ï‡•ã<br>‡§µ‡§∞‡§ø‡§∑‡•ç‡§† ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä<br>‡§∏‡§¶‡§∏‡•ç‡§Ø</td><td style="border:none; text-align:center; vertical-align:top;">...........................<br>‡§®‡§æ‡§™‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§ï‡•ã <br>‡§™‡•ç‡§∞‡§§‡§ø‡§®‡§ø‡§ß‡§ø<br>‡§∏‡§¶‡§∏‡•ç‡§Ø</td><td style="border:none; text-align:center; vertical-align:top;">...........................<br>‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§Æ‡§æ‡§≤‡§™‡•ã‡§§ ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§<br>‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑</td></tr></table>
        `;
        document.getElementById('print-preview').innerHTML = html;
        window.generatedAppName = firstAppName || '‡§®‡§ø‡§µ‡•á‡§¶‡§ï';
    }

    function saveToLocal() {
        const inputs = {};
        document.querySelectorAll('input:not([id^="mohi_assign"]), textarea, select').forEach(el => {
            if (el.id) inputs[el.id] = (el.type === 'checkbox' || el.type === 'radio') ? el.checked : el.value;
            else if (el.name && el.type === 'radio' && el.checked) inputs[el.name] = el.value;
        });
        const heirRows = [];
        document.querySelectorAll('#heir_table tbody tr').forEach(tr => {
            heirRows.push({ rel: tr.querySelector('.h-rel').value, name: tr.querySelector('.h-name').value, rem: tr.querySelector('.h-rem').value });
        });
        const landRows = [];
        document.querySelectorAll('#land_table tbody tr').forEach(tr => {
            landRows.push({
                vdc: tr.querySelector('.l-vdc').value, ward: tr.querySelector('.l-ward').value, kit: tr.querySelector('.l-kit').value,
                area: tr.querySelector('.l-area').value, khalo: tr.querySelector('.l-khalo').value, virah: tr.querySelector('.l-virah').value,
                kisim: tr.querySelector('.l-kisim').value, prakriti: tr.querySelector('.l-prakriti').value
            });
        });
        const data = { inputs, applicants, mohiGroups, fbRemarkGroups, heirRows, landRows };
        localStorage.setItem(FORM_KEY, JSON.stringify(data));
    }

    function restoreFromLocal() {
        try {
            const raw = localStorage.getItem(FORM_KEY);
            if (!raw) return false;
            const data = JSON.parse(raw);
            if (!data.landRows) return false;

            applicants = data.applicants || []; renderApplicantList();
            mohiGroups = data.mohiGroups || []; renderMohiList();
            fbRemarkGroups = data.fbRemarkGroups || []; renderFbRemarkList();
            
            document.querySelector('#heir_table tbody').innerHTML = '';
            (data.heirRows || []).forEach(row => {
                addHeirRow(); const tr = document.querySelector('#heir_table tbody tr:last-child');
                tr.querySelector('.h-rel').value = row.rel; tr.querySelector('.h-name').value = row.name; tr.querySelector('.h-rem').value = row.rem;
            });

            document.querySelector('#land_table tbody').innerHTML = '';
            (data.landRows || []).forEach(row => {
                const tr = addLandRowHTML(row.vdc, row.ward);
                tr.querySelector('.l-kit').value = row.kit; tr.querySelector('.l-area').value = row.area;
                tr.querySelector('.l-khalo').value = row.khalo; tr.querySelector('.l-virah').value = row.virah;
                tr.querySelector('.l-kisim').value = row.kisim; tr.querySelector('.l-prakriti').value = row.prakriti;
            });

            // IMPORTANT: Build Checkbox DOM BEFORE restoring input values
            updateKittaSelectors(); 

            for (const [key, val] of Object.entries(data.inputs)) {
                const el = document.getElementById(key);
                if (el) { (el.type === 'checkbox') ? el.checked = val : el.value = val; }
                else { const radio = document.querySelector(`input[name="${key}"][value="${val}"]`); if (radio) radio.checked = true; }
            }

            checkSubject(); toggleMohi(); toggleJhagada();
            return true;
        } catch (e) {
            console.error("Data Corrupted", e);
            localStorage.removeItem(FORM_KEY);
            return false;
        }
    }

    function resetForm() { if (confirm("Are you sure?")) { localStorage.removeItem(FORM_KEY); location.reload(); } }
    document.querySelector('.form-pane').addEventListener('input', saveToLocal);
    document.querySelector('.form-pane').addEventListener('change', saveToLocal);

    function exportToWord() {
        const content = document.getElementById('print-preview').innerHTML;
        const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export</title><style>@page { size: 21cm 29.7cm; margin: 25.4mm 12.7mm 25.4mm 31.75mm; } body { font-family: 'Kalimati', Arial, sans-serif; text-align: justify; } table { border-collapse: collapse; width: 100%; } td, th { border: 1px solid #000; padding: 5px; vertical-align: middle; text-align: center; } .bold-text { font-weight: bold; }</style></head><body>`;
        const footer = "</body></html>";
        const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + content + footer);
        const fileDownload = document.createElement("a");
        document.body.appendChild(fileDownload);
        fileDownload.href = source;
        fileDownload.download = `‡§¶‡§∞‡•ç‡§§‡§æ_‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏_${window.generatedAppName}.doc`;
        fileDownload.click();
        document.body.removeChild(fileDownload);
    }
    window.onload = function () {
        // If no data found (Reset or First Load)
        if (!restoreFromLocal()) {
            addHeirRow(true,false);
            addNewGavisa(false); 
            updateKittaSelectors();
            
            // --- FOCUS ON DATE ONLY AFTER RESET/NEW FORM ---
            setTimeout(() => { document.getElementById('reg_no').focus(); }, 100);
        }
        
        updatePreview();

        // Nepali Numbers Input Handler
      // INPUT HANDLER: Nepali Numbers & Dot to Danda
        document.querySelector('.form-pane').addEventListener('input', function (e) {
            const target = e.target;
            if (target.type === 'checkbox' || target.type === 'radio') return;
            
            let val = target.value;
            let changed = false;
            const start = target.selectionStart;
            const end = target.selectionEnd;

            // 1. Convert English Numbers to Nepali
            if (/[0-9]/.test(val)) {
                val = val.replace(/[0-9]/g, m => '‡•¶‡•ß‡•®‡•©‡•™‡•´‡•¨‡•≠‡•Æ‡•Ø'[m]);
                changed = true;
            }

            // 2. Convert Dot (.) to Danda (‡•§) for Specific Fields
            // IDs: date (Main Date), inp_app_date (Issue Date), inp_app_cit (Citizenship No)
            if (['date', 'inp_app_date', 'inp_app_cit'].includes(target.id) && val.includes('.')) {
                val = val.replace(/\./g, '‡•§');
                changed = true;
            }

            // Apply Changes
            if (changed) {
                target.value = val;
                if (target.setSelectionRange) target.setSelectionRange(start, end);
                updatePreview();
                saveToLocal();
            }
        
        });
    };
</script>
</body>
</html>